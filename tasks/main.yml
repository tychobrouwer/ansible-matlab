---
# tasks file for matlab
- name: Install Required Dependencies
  ansible.builtin.apt:
    name:
      - wget
      - ca-certificates
      - debianutils
      - libasound2
      - libatomic1
      - libc6
      - libcairo-gobject2
      - libcairo2
      - libcap2
      - libcrypt1
      - libcups2
      - libdrm2
      - libfontconfig1
      - libfribidi0
      - libgbm1
      - libgdk-pixbuf-2.0-0
      - libgl1
      - libglib2.0-0
      - libgstreamer-plugins-base1.0-0
      - libgstreamer1.0-0
      - libgtk-3-0
      - libice6
      - libltdl7
      - libmd0
      - libnettle8
      - libnspr4
      - libnss3
      - libpam0g
      - libpango-1.0-0
      - libpangocairo-1.0-0
      - libpangoft2-1.0-0
      - libpixman-1-0
      - libsndfile1
      - libtirpc3
      - libudev1
      - libuuid1
      - libwayland-client0
      - libxcomposite1
      - libxcursor1
      - libxdamage1
      - libxfixes3
      - libxfont2
      - libxft2
      - libxinerama1
      - libxrandr2
      - libxt6
      - libxtst6
      - libxxf86vm1
      - locales
      - locales-all
      - make
      - net-tools
      - procps
      - sudo
      - unzip
      - zlib1g
      - gcc
      - g++
      - gfortran
      - csh
    update_cache: true
    autoremove: true
    clean: true
    install_recommends: false
    state: present

- name: Create MATLAB User
  ansible.builtin.user:
    name: "{{ matlab_user }}"
    shell: /bin/bash
    createhome: true

- name: Switch to MATLAB User and Download MPM
  ansible.builtin.get_url:
    url: "https://www.mathworks.com/mpm/glnxa64/mpm"
    dest: "/home/{{ matlab_user }}/mpm"
    mode: "0755"
    owner: "{{ matlab_user }}"
    group: "{{ matlab_user }}"

- name: Get input.txt to remote
  ansible.builtin.copy:
    src: "{{ matlab_input_file }}"
    dest: /home/{{ matlab_user }}/input.txt
    mode: "0644"
    owner: "{{ matlab_user }}"
    group: "{{ matlab_user }}"

- name: Install MATLAB using MPM
  ansible.builtin.shell: /home/{{ matlab_user }}/mpm install --inputfile /home/{{ matlab_user }}/input.txt
  register: matlab_install
  changed_when: "'All specified products are already installed' not in matlab_install.stderr"
  failed_when: (matlab_install.rc != 0) and ('All specified products are already installed' not in matlab_install.stderr)

- name: Create MATLAB Symlink
  ansible.builtin.file:
    src: "{{ matlab_install_location }}/bin/matlab"
    dest: "/usr/local/bin/matlab"
    state: link
    owner: root
    group: root

- name: Ensure matlab service file is on remote (systemd)
  ansible.builtin.template:
    src: matlab.service.j2
    dest: /etc/systemd/system/matlab.service
    mode: "0664"
    owner: root
    group: root

- name: Ensure matlab service is enabled and started
  ansible.builtin.service:
    name: matlab
    state: started
    enabled: true

